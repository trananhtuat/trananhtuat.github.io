let field=document.getElementsByClassName("block");newGrid=((e,t)=>{let r=new Array(t);for(let a=0;a<t;a++)r[a]=new Array(e);let a=0;for(let o=0;o<t;o++)for(let t=0;t<e;t++)r[o][t]={index:a++,value:0};return{board:r,width:e,height:t}}),resetGrid=(e=>{for(let t=0;t<e.height;t++)for(let r=0;r<e.width;r++)e.board[t][r].value=0;Array.from(field).forEach(e=>{e.style.background=TRANSPARENT})}),newTetromino=((e,t,r,a)=>{let o=Math.floor(Math.random()*e.length);return{block:JSON.parse(JSON.stringify(e[o])),color:t[o],x:r,y:a}}),drawTetromino=((e,t)=>{e.block.forEach((r,a)=>{r.forEach((r,o)=>{let l=e.x+a,n=e.y+o;r>0&&(field[t.board[l][n].index].style.background=e.color)})})}),clearTetromino=((e,t)=>{e.block.forEach((r,a)=>{r.forEach((r,o)=>{let l=e.x+a,n=e.y+o;r>0&&(field[t.board[l][n].index].style.background=TRANSPARENT)})})}),isInGrid=((e,t,r)=>e<r.height&&e>=0&&t>=0&&t<r.width),isFilled=((e,t,r)=>!!isInGrid(e,t,r)&&0!==r.board[e][t].value),movable=((e,t,r)=>{let a=e.x,o=e.y;switch(r){case DIRECTION.DOWN:a=e.x+1;break;case DIRECTION.LEFT:o=e.y-1;break;case DIRECTION.RIGHT:o=e.y+1}return e.block.every((e,r)=>e.every((e,l)=>{let n=a+r,s=o+l;return 0===e||isInGrid(n,s,t)&&!isFilled(n,s,t)}))}),moveDown=((e,t)=>{movable(e,t,DIRECTION.DOWN)&&(clearTetromino(e,t),e.x++,drawTetromino(e,t))}),moveLeft=((e,t)=>{movable(e,t,DIRECTION.LEFT)&&(clearTetromino(e,t),e.y--,drawTetromino(e,t))}),moveRight=((e,t)=>{movable(e,t,DIRECTION.RIGHT)&&(clearTetromino(e,t),e.y++,drawTetromino(e,t))}),rotatable=((e,t)=>{let r=JSON.parse(JSON.stringify(e.block));for(let e=0;e<r.length;e++)for(let t=0;t<e;++t)[r[t][e],r[e][t]]=[r[e][t],r[t][e]];return r.forEach(e=>e.reverse()),r.every((r,a)=>r.every((r,o)=>{let l=e.x+a,n=e.y+o;return 0===r||isInGrid(l,n,t)&&!isFilled(l,n,t)}))}),rotate=((e,t)=>{if(rotatable(e,t)){clearTetromino(e,t);for(let t=0;t<e.block.length;t++)for(let r=0;r<t;++r)[e.block[r][t],e.block[t][r]]=[e.block[t][r],e.block[r][t]];e.block.forEach(e=>e.reverse()),drawTetromino(e,t)}}),hardDrop=((e,t)=>{for(clearTetromino(e,t);movable(e,t,DIRECTION.DOWN);)e.x++;drawTetromino(e,t)}),updateGrid=((e,t)=>{e.block.forEach((r,a)=>{r.forEach((r,o)=>{let l=e.x+a,n=e.y+o;r>0&&isInGrid(l,n,t)&&(t.board[l][n].value=r)})})}),checkFilledRow=(e=>e.every(e=>0!==e.value)),deleteRow=((e,t)=>{for(let r=e;r>0;r--)for(let e=0;e<10;e++){t.board[r][e].value=t.board[r-1][e].value;let a=t.board[r][e].value;field[t.board[r][e].index].style.background=0===a?TRANSPARENT:COLORS[a-1]}}),checkGrid=(e=>{let t=0;e.board.forEach((r,a)=>{checkFilledRow(r)&&(deleteRow(a,e),t++)}),t>0&&updateGame(t)});let game={score:START_SCORE,speed:START_SPEED,level:1,state:GAME_STATE.END,interval:null},grid=newGrid(GRID_WIDTH,GRID_HEIGHT),tetromino=null,score_span=document.querySelector("#score"),level_span=document.querySelector("#level");score_span.innerHTML=game.score,gameLoop=(()=>{if(game.state===GAME_STATE.PLAY)if(movable(tetromino,grid,DIRECTION.DOWN))moveDown(tetromino,grid);else if(updateGrid(tetromino,grid),checkGrid(grid),tetromino=newTetromino(BLOCKS,COLORS,START_X,START_Y),movable(tetromino,grid,DIRECTION.DOWN))drawTetromino(tetromino,grid);else{game.state=GAME_STATE.END;let e=document.querySelector("body");e.classList.add("end"),e.classList.remove("play");let t=document.querySelector("#result-level"),r=document.querySelector("#result-score");t.innerHTML=game.level,r.innerHTML=game.score}}),gameStart=(()=>{game.state=GAME_STATE.PLAY,level_span.innerHTML="lv. 1",score_span.innerHTML="0",tetromino=newTetromino(BLOCKS,COLORS,START_X,START_Y),drawTetromino(tetromino,grid),game.interval=setInterval(gameLoop,game.speed)}),updateGame=(e=>{game.score+=e*MAIN_SCORE+(e-1)*BONUS_SCORE,game.level=Math.floor(game.score/800)+1;let t=game.speed<200?50:START_SPEED-50*game.level;t!==game.speed&&(game.speed=t,clearInterval(game.interval),game.interval=setInterval(gameLoop,game.speed)),level_span.innerHTML="lv. "+game.level,score_span.innerHTML=game.score}),gamePause=(()=>{game.state=GAME_STATE.PAUSE}),gameResume=(()=>{game.state=GAME_STATE.PLAY}),gameReset=(()=>{clearInterval(game.interval),resetGrid(grid),game.score=START_SCORE,game.speed=START_SPEED,game.state=GAME_STATE.END,game.level=1,game.interval=null,tetromino=null}),document.addEventListener("keydown",e=>{let t=document.querySelector("body");switch(e.preventDefault(),e.which){case KEY.DOWN:moveDown(tetromino,grid);break;case KEY.LEFT:moveLeft(tetromino,grid);break;case KEY.RIGHT:moveRight(tetromino,grid);break;case KEY.UP:rotate(tetromino,grid);break;case KEY.SPACE:hardDrop(tetromino,grid);break;case KEY.P:let r=document.querySelector("#btn-play");game.state!==GAME_STATE.PAUSE?(gamePause(),t.classList.add("pause"),t.classList.remove("play"),r.innerHTML="resume"):(t.classList.remove("pause"),t.classList.add("play"),gameResume())}});let btns=document.querySelectorAll('[id*="btn-"]');btns.forEach(e=>{let t=e.getAttribute("id"),r=document.querySelector("body");e.addEventListener("click",()=>{switch(t){case"btn-drop":hardDrop(tetromino,grid);break;case"btn-up":rotate(tetromino,grid);break;case"btn-down":moveDown(tetromino,grid);break;case"btn-left":moveLeft(tetromino,grid);break;case"btn-right":moveRight(tetromino,grid);break;case"btn-play":if(r.classList.add("play"),game.state===GAME_STATE.PAUSE)return r.classList.remove("pause"),void gameResume();gameStart();break;case"btn-theme":r.classList.toggle("dark"),document.querySelector("meta[name='theme-color'").setAttribute("content",r.classList.contains("dark")?"#243441":"#ECF0F3"),document.querySelector("meta[name='msapplication-navbutton-color'").setAttribute("content",r.classList.contains("dark")?"#243441":"#ECF0F3"),document.querySelector("meta[name='apple-mobile-web-app-status-bar-style'").setAttribute("content",r.classList.contains("dark")?"#243441":"#ECF0F3");break;case"btn-pause":gamePause(),document.querySelector("#btn-play").innerHTML="resume",r.classList.remove("play"),r.classList.add("pause");break;case"btn-new-game":gameReset(),r.classList.add("play"),r.classList.remove("pause"),r.classList.remove("end"),gameStart();break;case"btn-help":document.querySelector(".how-to").classList.toggle("active")}})});